<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Structural Inspection Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-item.active { color: #2563eb; }
        .report-nav-item.active { border-color: #2563eb; color: #2563eb; background-color: #ebf5ff; }
        #map-container { height: 70vh; width: 100%; border-radius: 0.5rem; z-index: 1; }
        #series-mode-btn.active {
            background-color: #f59e0b;
            color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.5);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- TOP HEADER -->
    <header class="bg-white shadow-sm sticky top-0 z-20 px-4 py-3 flex justify-between items-center border-b border-gray-200">
        <div>
            <h1 class="text-lg font-bold text-blue-800">Structural<span class="text-gray-800">Log</span></h1>
            <p class="text-xs text-gray-500 cursor-pointer hover:text-blue-600" onclick="document.getElementById('settings-modal').classList.remove('hidden')" id="project-header">Project: Bridge-001</p>
        </div>
        <div class="flex items-center gap-2">
            <div id="status-indicator" class="w-2 h-2 rounded-full bg-gray-400"></div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 text-gray-500 hover:text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- TAB 1: INSPECT (CAMERA & NOTES) -->
    <div id="tab-inspect" class="tab-content active p-4 max-w-lg mx-auto space-y-6">
        
        <!-- Camera Button -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                <span class="font-bold text-gray-700">Add Photo</span>
                <span class="text-xs text-gray-400 uppercase tracking-wider">Camera</span>
            </div>
            <div class="p-8 flex flex-col items-center justify-center space-y-4">
                <label for="camera-input" class="cursor-pointer group relative">
                    <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center shadow-xl group-hover:bg-blue-500 transition transform group-active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                </label>
                <p class="text-sm text-gray-500 font-medium" id="photo-capture-label">Tap to Capture Photo</p>
                
                <button id="series-mode-btn" onclick="window.toggleSeriesMode()" class="px-4 py-1.5 rounded-full text-sm font-bold shadow transition border border-gray-300">
                    <span id="series-mode-text">Enable Photo Series</span>
                </button>
            </div>
        </div>

        <!-- New Persistent Note Input -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                <span class="font-bold text-gray-700">Quick Observation Note</span>
                <span class="text-xs text-gray-400 uppercase tracking-wider">TEXT</span>
            </div>
            <div class="p-4 space-y-3">
                <textarea id="quick-note-input" class="w-full border border-gray-300 rounded-lg p-3 text-sm h-24 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Type detailed observation here..."></textarea>
                <button onclick="window.confirmQuickNote()" id="quick-note-save-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg shadow transition">
                    Save Note
                </button>
            </div>
        </div>

        <!-- Tips -->
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
            <h3 class="text-sm font-bold text-blue-800 mb-2">Inspection Tips</h3>
            <ul class="text-xs text-blue-700 list-disc list-inside space-y-1">
                <li>Include reference scale in photos.</li>
                <li>Notes are searchable in the report view.</li>
            </ul>
        </div>

    </div>

    <!-- TAB 2: REPORT LOG -->
    <div id="tab-report" class="tab-content p-4 max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Inspection Log</h2>
            <button onclick="window.generateReportPDF()" class="text-sm bg-red-600 text-white font-semibold hover:bg-red-700 px-3 py-1.5 rounded-lg shadow transition">
                Generate Report PDF
            </button>
        </div>
        
        <div class="mb-4 space-y-2">
            <div class="flex gap-2">
                <input type="text" id="report-search" placeholder="Search logs..." class="flex-1 bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="sort-select" onchange="window.setSortOrder(this.value)" class="bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
        </div>

        <div class="flex border-b border-gray-300 mb-4">
            <button id="nav-log-photos" class="report-nav-item active px-4 py-2 text-sm font-semibold border-b-2 border-transparent" onclick="window.setReportFilter('photo')">Photo Log</button>
            <button id="nav-log-notes" class="report-nav-item px-4 py-2 text-sm font-semibold border-b-2 border-transparent" onclick="window.setReportFilter('note')">Notes Log</button>
            <button id="nav-log-all" class="report-nav-item px-4 py-2 text-sm font-semibold border-b-2 border-transparent" onclick="window.setReportFilter('all')">All Entries</button>
        </div>

        <div id="photo-log-controls" class="mb-4 flex justify-end gap-2">
            <button id="download-photos-btn" onclick="window.downloadAllPhotosZip()" class="text-xs bg-indigo-600 text-white font-semibold hover:bg-indigo-700 px-3 py-1.5 rounded-lg shadow transition flex items-center gap-1">Download Photos (ZIP)</button>
             <button id="download-notes-btn" onclick="window.downloadNotesTextReport()" class="text-xs bg-gray-600 text-white font-semibold hover:bg-gray-700 px-3 py-1.5 rounded-lg shadow transition flex items-center gap-1">Download Notes (TXT)</button>
        </div>
        
        <div id="report-feed" class="space-y-4">
            <div class="text-center text-gray-500 py-10">Loading inspection data...</div>
        </div>
    </div>

    <!-- TAB 3: MAP VIEW -->
    <div id="tab-map" class="tab-content p-4 max-w-4xl mx-auto h-full">
        <div class="bg-white rounded-lg shadow border border-gray-200 p-4 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-gray-700">Project Map</h2>
                <div class="text-xs text-gray-500">Locations for Photos & Notes</div>
            </div>
            <div id="map-container" class="bg-gray-100 rounded"></div>
        </div>
    </div>

    <!-- TAB 4: RAW FILES -->
    <div id="tab-files" class="tab-content p-4 max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="font-bold text-gray-700">Raw Storage Browser</h2>
                <div class="flex gap-2">
                    <button onclick="window.browserUp()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs font-bold border">‚¨Ü Up</button>
                    <button onclick="window.refreshBrowser()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs font-bold border">‚Üª</button>
                </div>
            </div>
            <div id="browser-path" class="text-xs font-mono text-gray-500 mb-2 truncate">/</div>
            <div id="browser-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 flex justify-around items-center h-16 z-30 pb-safe">
        <button onclick="window.switchTab('inspect')" id="nav-inspect" class="nav-item active flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üì∑</span>
            <span class="text-[10px] font-bold mt-1">Inspect</span>
        </button>
        <button onclick="window.switchTab('report')" id="nav-report" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üìã</span>
            <span class="text-[10px] font-bold mt-1">Report</span>
        </button>
        <button onclick="window.switchTab('map')" id="nav-map" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üó∫Ô∏è</span>
            <span class="text-[10px] font-bold mt-1">Map</span>
        </button>
        <button onclick="window.switchTab('files')" id="nav-files" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üóÑÔ∏è</span>
            <span class="text-[10px] font-bold mt-1">Raw Files</span>
        </button>
    </nav>

    <!-- MODALS -->
    <div id="caption-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex flex-col justify-center p-4">
        <div class="bg-white rounded-xl overflow-hidden shadow-2xl max-w-md mx-auto w-full">
            <div class="relative h-64 bg-gray-100 flex items-center justify-center">
                <img id="modal-img-preview" class="max-h-full max-w-full object-contain">
            </div>
            <div class="p-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Photo Caption</label>
                <textarea id="modal-caption-input" class="w-full border border-gray-300 rounded-lg p-3 text-sm h-24 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4 resize-none" placeholder="e.g. Hairline crack..."></textarea>
                <button id="ai-caption-btn" onclick="window.generateAICaption()" class="w-full mb-3 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow transition">Analyze & Suggest Caption ‚ú®</button>
                <div class="flex gap-3">
                    <button onclick="window.cancelUpload()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-lg">Discard</button>
                    <button onclick="window.confirmUpload()" id="modal-save-btn" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow">Save & Upload</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editor-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex flex-col justify-center p-4">
        <div class="bg-white rounded-xl overflow-hidden shadow-2xl max-w-md mx-auto w-full">
            <div class="bg-gray-100 p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-gray-800" id="editor-title">Edit Log Entry</h3>
                <button onclick="window.closeEditorModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div id="editor-photo-preview" class="hidden relative h-32 bg-gray-100 mb-3 flex items-center justify-center border border-gray-200 rounded"><img id="editor-preview-img" class="max-h-full max-w-full object-contain"></div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="editor-label">Text</label>
                <textarea id="editor-text-input" class="w-full border border-gray-300 rounded-lg p-3 text-sm h-32 resize-none"></textarea>
                <button onclick="window.updateLogEntry()" id="editor-save-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-800">Settings</h3><button onclick="document.getElementById('settings-modal').classList.add('hidden')">‚úï</button></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Active Project</label>
                    <div class="flex gap-2">
                        <select id="project-select" class="flex-1 border border-gray-300 rounded p-2 text-sm bg-white" onchange="window.switchProject(this.value)"></select>
                        <button onclick="window.toggleNewProjectInput()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-lg font-bold">+</button>
                    </div>
                    <div id="new-project-div" class="hidden mt-2 p-2 bg-blue-50 rounded border border-blue-100">
                        <input type="text" id="new-project-input" placeholder="Enter Project ID" class="w-full border border-blue-200 rounded p-2 text-sm mb-2">
                        <div class="flex gap-2"><button onclick="window.createNewProject()" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded">Create</button><button onclick="window.toggleNewProjectInput()" class="bg-gray-200 text-gray-600 px-3 rounded text-xs">Cancel</button></div>
                    </div>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200"><button onclick="window.importLegacyFiles()" class="w-full bg-yellow-100 text-yellow-800 text-xs font-bold py-2 rounded">Scan & Import Missing Photos</button></div>
                <div class="bg-gray-50 p-3 rounded border border-gray-200"><button onclick="window.copyStorageRules()" class="w-full bg-white text-gray-600 text-xs font-bold py-2 rounded">Copy Storage Rules</button></div>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="mt-6 w-full py-3 bg-gray-800 text-white font-bold rounded-lg">Close</button>
        </div>
    </div>
    
    <div id="st-rules" class="hidden">rules_version = '2'; service firebase.storage { match /b/{bucket}/o { match /artifacts/{appId}/{allPaths=**} { allow read, write: if request.auth != null; } } }</div>
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm font-bold opacity-0 transition-opacity duration-300 pointer-events-none z-[60]">Photo Added</div>
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-black/80 hidden flex flex-col items-center justify-center text-white"><div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mb-4"></div><p id="loading-text" class="font-medium">Uploading...</p></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, where, onSnapshot, getDocs, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, listAll, getMetadata, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        
        function saveAs(blob, filename) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const config = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyD2jsJTjSlWf3SINS3u4fz3Lu5IYbI6N94", authDomain: "field-cam.firebaseapp.com", projectId: "field-cam", storageBucket: "field-cam.firebasestorage.app", messagingSenderId: "952385597528", appId: "1:952385597528:web:3a5b2011a4cc2b29e41a2d" };

        let db, storage, auth, user;
        let currentProject = localStorage.getItem('fc_active_project') || "Bridge-001";
        let knownProjects = new Set(JSON.parse(localStorage.getItem('fc_projects') || '["Bridge-001"]'));
        
        let pendingBlob = null, pendingBase64 = null;
        let browserPath = `artifacts/${appId}/public/data/files`;
        let currentEditingItem = null, currentReportFilter = 'photo', currentSort = 'newest';
        let isSeriesMode = false, seriesPhotoQueue = [];
        let cachedItems = [], currentLocation = null, mapInstance = null, markerGroup = null;

        // -- CORE FUNCTIONS MOVED TO TOP SCOPE --
        
        function blobToBase64(blob) { return new Promise((r,j) => { const reader=new FileReader(); reader.onloadend=()=>r(reader.result.split(',')[1]); reader.onerror=j; reader.readAsDataURL(blob); }); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.classList.remove('opacity-0'); setTimeout(()=>t.classList.add('opacity-0'), 2000); }
        function updateStatus(s) { document.getElementById('status-indicator').className=`w-2 h-2 rounded-full ${s==='online'?'bg-green-500':'bg-red-500'}`; }
        function setLoading(a,t="Loading") { document.getElementById('loading-overlay').classList.toggle('hidden',!a); document.getElementById('loading-text').innerText=t; }

        async function loadBrowser(path) {
            browserPath = path;
            const grid = document.getElementById('browser-grid');
            document.getElementById('browser-path').innerText = path;
            grid.innerHTML = '<div class="col-span-full text-center text-gray-400 text-sm">Scanning...</div>';
            try {
                const res = await listAll(ref(storage, path));
                grid.innerHTML = "";
                res.prefixes.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "bg-yellow-50 border border-yellow-200 rounded p-3 text-center cursor-pointer hover:bg-yellow-100";
                    div.onclick = () => window.loadBrowser(p.fullPath);
                    div.innerHTML = `<div class="text-2xl mb-1">üìÅ</div><div class="text-xs truncate font-bold text-yellow-800">${p.name}</div>`;
                    grid.appendChild(div);
                });
                for (const item of res.items) {
                    const url = await getDownloadURL(item);
                    const div = document.createElement('div');
                    div.className = "bg-white border border-gray-200 rounded overflow-hidden shadow-sm relative group";
                    div.innerHTML = `<div class="h-24 bg-gray-100 relative"><img src="${url}" class="w-full h-full object-cover"></div><div class="p-2 text-[10px] text-gray-500 truncate">${item.name}</div><a href="${url}" target="_blank" class="absolute inset-0"></a>`;
                    grid.appendChild(div);
                }
                if(res.prefixes.length===0 && res.items.length===0) grid.innerHTML = '<div class="col-span-full text-center text-gray-300 text-sm py-4">Empty Folder</div>';
            } catch(e) {
                console.warn("Browser Error", e.code);
                grid.innerHTML = `<div class="col-span-full text-center text-red-400 text-xs py-4">Error: ${e.code}</div>`;
            }
        }

        async function _generatePDF_Core() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'letter' });
            const margin = 15; const pW = 215.9; let y = margin;
            
            const sortedItems = [...cachedItems].sort((a,b) => a.timestamp - b.timestamp);
            const photos = sortedItems.filter(i => i.type === 'photo');
            const notes = sortedItems.filter(i => i.type === 'note');

            doc.setFontSize(20); doc.text(`Structural Inspection Report`, pW/2, y, {align:'center'}); y+=10;
            doc.setFontSize(14); doc.text(`Project: ${currentProject}`, pW/2, y, {align:'center'}); y+=15;

            if (photos.length > 0) {
                doc.setFontSize(16); doc.text("Photo Log", margin, y); y+=10;
                const loadedPhotos = await Promise.all(photos.map(async p => {
                    try {
                        const resp = await fetch(p.url); const blob = await resp.blob();
                        const base64 = await new Promise((r) => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight; c.getContext('2d').drawImage(img,0,0); r({data:c.toDataURL('image/jpeg', 0.8).split(',')[1], w:img.naturalWidth, h:img.naturalHeight}); }; img.src = URL.createObjectURL(blob); });
                        return { ...p, base64: base64.data, w: base64.w, h: base64.h };
                    } catch { return { ...p, base64: null }; }
                }));

                const targetW = 80;
                for (let i = 0; i < loadedPhotos.length; i++) {
                    const p = loadedPhotos[i];
                    let photoH = 60;
                    if(p.w && p.h) photoH = targetW * (p.h / p.w);
                    if(photoH > 100) photoH = 100;
                    
                    const rowH = photoH + 25;
                    if (y + rowH > 270) { doc.addPage(); y = margin; }

                    const col = i % 2;
                    const xPos = margin + (col * (targetW + 10));
                    if (col === 0 && i > 0) y += rowH; 

                    if(p.base64) doc.addImage(p.base64, 'JPEG', xPos, y, targetW, photoH);
                    doc.setFontSize(9); doc.setFont("helvetica", "bold"); doc.text(`Photo #${p.id.substring(8)}`, xPos, y+photoH+5);
                    doc.setFont("helvetica", "normal"); const split = doc.splitTextToSize(p.caption, targetW); doc.text(split, xPos, y+photoH+10);
                }
                y += 80; 
            }

            if (notes.length > 0) {
                doc.addPage(); y = margin; doc.setFontSize(16); doc.text("Field Notes", margin, y); y+=10; doc.setFontSize(10);
                notes.forEach(n => {
                    const text = doc.splitTextToSize(`[${n.dateString}] ${n.text}`, pW - (margin*2));
                    if (y + (text.length*5) > 270) { doc.addPage(); y = margin; }
                    doc.text(text, margin, y); y += (text.length * 5) + 5;
                });
            }
            doc.save(`Report_${currentProject}.pdf`);
        }

        function initMap() {
            if (typeof L === 'undefined' || !document.getElementById('map-container')) return;
            if (!mapInstance) {
                mapInstance = L.map('map-container').setView([39.8, -98.5], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                markerGroup = L.layerGroup().addTo(mapInstance);
            }
            markerGroup.clearLayers();
            let bounds = [];
            cachedItems.forEach(item => {
                if (item.lat && item.lng) {
                    const m = L.marker([item.lat, item.lng]).bindPopup(item.caption || item.text);
                    markerGroup.addLayer(m);
                    bounds.push([item.lat, item.lng]);
                }
            });
            if(bounds.length) mapInstance.fitBounds(bounds, {padding:[50,50]});
        }

        function renderReport(items) {
            const feed = document.getElementById('report-feed');
            feed.innerHTML = "";
            let filtered = items.filter(i => currentReportFilter === 'all' || i.type === currentReportFilter);
            filtered = filtered.sort((a,b) => currentSort === 'newest' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp);

            if(filtered.length === 0) { feed.innerHTML = `<div class="text-center text-gray-400 py-10">No items found.</div>`; return; }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex";
                let left = item.type === 'note' ? `<div class="w-16 bg-yellow-50 flex items-center justify-center text-2xl">üìù</div>` : `<div class="w-1/3 bg-gray-100 relative"><img src="${item.url}" class="absolute inset-0 w-full h-full object-cover"></div>`;
                div.innerHTML = `${left}<div class="p-3 flex-1 flex flex-col justify-between"><div><div class="text-xs text-gray-400 mb-1 flex justify-between"><span>${item.dateString}</span>${item.lat?'<span>üìç</span>':''}</div><p class="text-sm font-medium">${item.caption || item.text}</p></div><div class="flex justify-end gap-2 mt-2"><button onclick="window.openEditorModal('${item.id}','${item.type}')" class="text-xs text-blue-500 font-bold">Edit</button><button onclick="window.deleteEntry('${item.id}','${item.storagePath}')" class="text-xs text-red-500 font-bold">Delete</button></div></div>`;
                feed.appendChild(div);
            });
        }

        function loadReport() {
            const q = query(collection(db, `artifacts/${appId}/public/data/images`), where("projectId", "==", currentProject));
            onSnapshot(q, (s) => { 
                cachedItems = []; s.forEach(d=>cachedItems.push(d.data())); 
                renderReport(cachedItems); 
                if(document.getElementById('tab-map').style.display === 'block') initMap();
            });
        }

        function filterReport(txt) {
            const lower = txt.toLowerCase();
            const cards = document.querySelectorAll('#report-feed > div');
            cards.forEach(c => { c.style.display = c.innerText.toLowerCase().includes(lower) ? 'flex' : 'none'; });
        }

        // --- GLOBAL EXPORTS (Before Init) ---
        window.loadBrowser = loadBrowser; // Fix reference error
        window.cancelUpload = () => { if(isSeriesMode && confirm("Discard queue?")) seriesPhotoQueue=[]; document.getElementById('caption-modal').classList.add('hidden'); };
        window.toggleSeriesMode = () => { isSeriesMode=!isSeriesMode; document.getElementById('series-mode-btn').classList.toggle('active', isSeriesMode); if(!isSeriesMode && seriesPhotoQueue.length>0) openBatchCaptionModal(); };
        window.openEditorModal = (id, type) => { currentEditingItem = cachedItems.find(i=>i.id===id); document.getElementById('editor-modal').classList.remove('hidden'); document.getElementById('editor-text-input').value = type==='photo'?currentEditingItem.caption:currentEditingItem.text; };
        window.closeEditorModal = () => document.getElementById('editor-modal').classList.add('hidden');
        window.updateLogEntry = async () => { const txt = document.getElementById('editor-text-input').value; await setDoc(doc(db, `artifacts/${appId}/public/data/images`, currentEditingItem.id), currentEditingItem.type==='photo'?{caption:txt}:{text:txt}, {merge:true}); window.closeEditorModal(); };
        window.deleteEntry = async (id, path) => { if(confirm("Delete?")) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/images`, id)); if(path) deleteObject(ref(storage, path)); } };
        window.switchTab = (id) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${id}`).classList.add('active'); 
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active','text-blue-600')); document.getElementById(`nav-${id}`).classList.add('active','text-blue-600');
            if(id==='map') setTimeout(initMap, 200);
            if(id==='files') loadBrowser(browserPath);
        }
        window.updateProjectID = (v) => { currentProject=v; document.getElementById('project-header').innerText=`Project: ${v}`; loadReport(); };
        window.toggleNewProjectInput = () => document.getElementById('new-project-div').classList.toggle('hidden');
        window.createNewProject = () => { const v=document.getElementById('new-project-input').value; if(v){ addProjectToSet(v); window.switchProject(v); } };
        window.switchProject = (v) => { currentProject=v; localStorage.setItem('fc_active_project',v); updateProjectHeader(); loadReport(); };
        window.setSortOrder = (o) => { currentSort=o; renderReport(cachedItems); };
        window.browserUp = () => { const p=browserPath.split('/'); if(p.length>1){p.pop();loadBrowser(p.join('/'));} };
        window.refreshBrowser = () => loadBrowser(browserPath);
        window.copyStorageRules = () => navigator.clipboard.writeText(document.getElementById('st-rules').innerText);
        window.importLegacyFiles = async () => { if(confirm("Scan storage?")) { const scan=async(r,pn)=>{const l=await listAll(r);for(const f of l.items){const id=f.name.split('.')[0];const u=await getDownloadURL(f);await setDoc(doc(db,`artifacts/${appId}/public/data/images`,id),{id,projectId:pn||"Unsorted",url:u,storagePath:f.fullPath,caption:"Imported",timestamp:Date.now(),dateString:"Imported"},{merge:true});}for(const p of l.prefixes){addProjectToSet(p.name);await scan(p,p.name);}}; await scan(ref(storage,`artifacts/${appId}/public/data/files`),"Unsorted"); alert("Done"); } };
        
        window.setReportFilter = (filter) => {
            currentReportFilter = filter;
            const btns = { 'photo': 'nav-log-photos', 'note': 'nav-log-notes', 'all': 'nav-log-all' };
            for (const key in btns) {
                const el = document.getElementById(btns[key]);
                if(el) { el.classList.remove('active'); if(key===filter) el.classList.add('active'); }
            }
            const btnPhotos = document.getElementById('download-photos-btn');
            const btnNotes = document.getElementById('download-notes-btn');
            if(btnPhotos) btnPhotos.classList.toggle('hidden', filter === 'note');
            if(btnNotes) btnNotes.classList.toggle('hidden', filter === 'photo');
            renderReport(cachedItems);
        };

        window.generateReportPDF = async () => {
            setLoading(true, "Generating Report...");
            try { await _generatePDF_Core(); } catch(e) { console.error(e); alert("PDF Error"); } finally { setLoading(false); }
        };

        window.downloadAllPhotosZip = async () => {
            const photos = cachedItems.filter(i => i.type === 'photo');
            if (photos.length === 0) return alert("No photos.");
            setLoading(true, "Zipping...");
            try {
                const zip = new JSZip();
                const promises = photos.map(async p => { if(p.storagePath) { const r=await fetch(p.url); const b=await r.blob(); zip.file(`${p.projectId}_${p.id}.jpg`, b); } });
                await Promise.all(promises);
                const c = await zip.generateAsync({type:"blob"});
                saveAs(c, `${currentProject}_Photos.zip`);
            } catch(e) { console.error(e); alert("Zip Failed"); } finally { setLoading(false); }
        };

        window.downloadNotesTextReport = () => {
            const notes = cachedItems.filter(i => i.type === 'note');
            if (notes.length === 0) return alert("No notes.");
            let txt = `NOTES REPORT - ${currentProject}\n\n`;
            notes.forEach(n => { txt += `[${n.dateString}]\n${n.text}\n-----------------\n`; });
            saveAs(new Blob([txt],{type:'text/plain'}), `${currentProject}_Notes.txt`);
        };

        window.handleCameraInput = (e) => {
            const file = e.target.files[0]; if(!file) return; pendingBlob=file;
            if (isSeriesMode) {
                const id = Date.now().toString();
                seriesPhotoQueue.push({ id, blob: pendingBlob, base64: null, timestamp: new Date() });
                showToast(`Photo #${seriesPhotoQueue.length} Added`);
                document.getElementById('photo-capture-label').innerText = `Series Active: ${seriesPhotoQueue.length} photos`;
                e.target.value = "";
                blobToBase64(file).then(b => { seriesPhotoQueue[seriesPhotoQueue.length - 1].base64 = b; });
                return;
            }
            const url = URL.createObjectURL(file);
            document.getElementById('modal-img-preview').src=url;
            document.getElementById('modal-caption-input').value="";
            document.getElementById('ai-caption-btn').classList.remove('hidden');
            document.getElementById('modal-save-btn').innerText = "Save & Upload";
            document.getElementById('caption-modal').classList.remove('hidden');
            blobToBase64(file).then(b=>{pendingBase64=b});
        };

        window.confirmUpload = async () => {
             if(!user) return alert("Error: No user found.");
             let itemsToProcess = [];
             let caption = document.getElementById('modal-caption-input').value.trim() || "No Caption";
             if (seriesPhotoQueue.length > 0) {
                 itemsToProcess = seriesPhotoQueue.map(p => ({ blob: p.blob, id: p.id, caption: caption }));
                 seriesPhotoQueue = [];
                 document.getElementById('photo-capture-label').innerText = "Tap to Capture Photo";
             } else if (pendingBlob) {
                 itemsToProcess.push({ blob: pendingBlob, id: Date.now().toString(), caption: caption });
                 pendingBlob = null;
             } else { return alert("No photo ready."); }
             
             setLoading(true, `Uploading ${itemsToProcess.length} files...`);
             try {
                 const uploads = itemsToProcess.map(async (item) => {
                     const path = `artifacts/${appId}/public/data/files/${currentProject}/${item.id}.jpg`;
                     const snap = await uploadBytes(ref(storage, path), item.blob);
                     const url = await getDownloadURL(snap.ref);
                     await setDoc(doc(db, `artifacts/${appId}/public/data/images`, item.id), {
                         id: item.id, type:'photo', projectId:currentProject, url, storagePath:path, caption:item.caption, timestamp:Date.now(), dateString:new Date().toLocaleString(), lat:currentLocation?.lat || null, lng:currentLocation?.lng || null
                     });
                 });
                 await Promise.all(uploads);
                 addProjectToSet(currentProject);
                 document.getElementById('caption-modal').classList.add('hidden');
                 isSeriesMode = false;
                 document.getElementById('series-mode-btn').classList.remove('active');
                 document.getElementById('series-mode-btn').innerHTML = '<span id="series-icon">üîÑ</span> Enable Photo Series';
                 switchTab('report');
             } catch(e) { alert("Upload Failed: " + e.message); } finally { setLoading(false); }
        };

        window.confirmQuickNote = async () => { 
             const txt = document.getElementById('quick-note-input').value; if(!txt) return;
             await setDoc(doc(db, `artifacts/${appId}/public/data/images`, Date.now().toString()), {
                 id: Date.now().toString(), type:'note', projectId:currentProject, text:txt, timestamp:Date.now(), dateString:new Date().toLocaleString(), lat:currentLocation?.lat || null, lng:currentLocation?.lng || null
             });
             document.getElementById('quick-note-input').value="";
             loadReport();
        };
        
        window.generateAICaption = async () => {
            if (!pendingBase64) return alert("Photo still loading.");
            const btn = document.getElementById('ai-caption-btn'); btn.disabled=true; btn.innerText="Analyzing...";
            const key = ""; 
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{parts:[{text:"Analyze structural defect, return short caption max 15 words."},{inlineData:{mimeType:"image/jpeg",data:pendingBase64}}]}]})
                });
                const res = await r.json();
                document.getElementById('modal-caption-input').value = res.candidates[0].content.parts[0].text.trim();
            } catch(e) { console.error(e); alert("AI Failed"); } finally { btn.disabled=false; btn.innerText="Analyze & Suggest Caption ‚ú®"; }
        };

        function addProjectToSet(p){ knownProjects.add(p); localStorage.setItem('fc_projects', JSON.stringify(Array.from(knownProjects))); renderProjectOptions(); }
        function renderProjectOptions() { const s=document.getElementById('project-select'); s.innerHTML=''; Array.from(knownProjects).sort().forEach(p=>{const o=document.createElement('option');o.value=p;o.text=p;if(p===currentProject)o.selected=true;s.appendChild(o)}); }
        function updateProjectHeader() { document.getElementById('project-header').innerText=`Project: ${currentProject}`; }

        // --- INIT ---
        async function init() {
            const app = initializeApp(config);
            auth = getAuth(app); db = getFirestore(app); storage = getStorage(app);

            onAuthStateChanged(auth, (u) => {
                user = u;
                updateStatus(u ? 'online' : 'offline');
                if(u) {
                    loadReport();
                    browserPath = `artifacts/${appId}/public/data/files`;
                    loadBrowser(browserPath);
                }
            });

            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (token) { try { await signInWithCustomToken(auth, token); } catch { await signInAnonymously(auth); } }
            else { await signInAnonymously(auth); }

            document.getElementById('camera-input').onchange = handleCameraInput;
            document.getElementById('report-search').oninput = (e) => filterReport(e.target.value);
            if (navigator.geolocation) navigator.geolocation.watchPosition(p => currentLocation = { lat: p.coords.latitude, lng: p.coords.longitude });

            updateProjectHeader(); renderProjectOptions();
            setTimeout(() => window.setReportFilter(currentReportFilter), 100);
        }

        init();
    </script>
</body>
</html>
