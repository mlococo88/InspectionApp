<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Structural Inspection Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-item.active { color: #2563eb; }
        .report-nav-item.active { border-color: #2563eb; color: #2563eb; background-color: #ebf5ff; }
        /* Style for active series mode button */
        #series-mode-btn.active {
            background-color: #f59e0b; /* Amber 500 */
            color: #1f2937; /* Dark text */
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.5);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- TOP HEADER -->
    <header class="bg-white shadow-sm sticky top-0 z-20 px-4 py-3 flex justify-between items-center border-b border-gray-200">
        <div>
            <h1 class="text-lg font-bold text-blue-800">Structural<span class="text-gray-800">Log</span></h1>
            <p class="text-xs text-gray-500 cursor-pointer hover:text-blue-600" onclick="document.getElementById('settings-modal').classList.remove('hidden')" id="project-header">Project: Bridge-001</p>
        </div>
        <div class="flex items-center gap-2">
            <div id="status-indicator" class="w-2 h-2 rounded-full bg-gray-400"></div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 text-gray-500 hover:text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- TAB 1: INSPECT (CAMERA & NOTES) -->
    <div id="tab-inspect" class="tab-content active p-4 max-w-lg mx-auto space-y-6">
        
        <!-- Camera Button -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                <span class="font-bold text-gray-700">Add Photo</span>
                <span class="text-xs text-gray-400 uppercase tracking-wider">Camera</span>
            </div>
            <div class="p-8 flex flex-col items-center justify-center space-y-4">
                <label for="camera-input" class="cursor-pointer group relative">
                    <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center shadow-xl group-hover:bg-blue-500 transition transform group-active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                </label>
                <p class="text-sm text-gray-500 font-medium" id="photo-capture-label">Tap to Capture Photo</p>
                
                <button id="series-mode-btn" onclick="toggleSeriesMode()" class="px-4 py-1.5 rounded-full text-sm font-bold shadow transition border border-gray-300">
                    <span id="series-mode-text">Enable Photo Series</span>
                </button>
            </div>
        </div>

        <!-- New Persistent Note Input -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                <span class="font-bold text-gray-700">Quick Observation Note</span>
                <span class="text-xs text-gray-400 uppercase tracking-wider">TEXT</span>
            </div>
            <div class="p-4 space-y-3">
                <textarea id="quick-note-input" class="w-full border border-gray-300 rounded-lg p-3 text-sm h-24 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Type detailed observation here..."></textarea>
                <button onclick="confirmQuickNote()" id="quick-note-save-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg shadow transition">
                    Save Note
                </button>
            </div>
        </div>

        <!-- Tips -->
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
            <h3 class="text-sm font-bold text-blue-800 mb-2">Inspection Tips</h3>
            <ul class="text-xs text-blue-700 list-disc list-inside space-y-1">
                <li>Include reference scale in photos.</li>
                <li>Notes are searchable in the report view.</li>
            </ul>
        </div>

    </div>

    <!-- TAB 2: REPORT LOG (FIRESTORE) -->
    <div id="tab-report" class="tab-content p-4 max-w-2xl mx-auto">
        
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Inspection Log</h2>
            <!-- NEW REPORT BUTTON -->
            <button onclick="generateReportPDF()" class="text-sm bg-red-600 text-white font-semibold hover:bg-red-700 px-3 py-1.5 rounded-lg shadow transition">
                Generate Report PDF
            </button>
        </div>
        
        <!-- Filter/Search -->
        <div class="mb-4">
            <input type="text" id="report-search" placeholder="Search logs..." class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Report Sub-Navigation -->
        <div class="flex border-b border-gray-300 mb-4">
            <button id="nav-log-photos" class="report-nav-item active px-4 py-2 text-sm font-semibold border-b-2 border-transparent" onclick="window.setReportFilter('photo')">Photo Log</button>
            <button id="nav-log-notes" class="report-nav-item px-4 py-2 text-sm font-semibold border-b-2 border-transparent" onclick="window.setReportFilter('note')">Notes Log</button>
            <button id="nav-log-all" class="report-nav-item px-4 py-2 text-sm font-semibold border-b-2 border-transparent" onclick="window.setReportFilter('all')">All Entries</button>
        </div>

        <!-- Photo Log Controls -->
        <div id="photo-log-controls" class="mb-4 flex justify-end gap-2">
            <button id="download-photos-btn" onclick="downloadAllPhotosZip()" class="text-xs bg-indigo-600 text-white font-semibold hover:bg-indigo-700 px-3 py-1.5 rounded-lg shadow transition flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download Photos (ZIP)
            </button>

            <!-- NEW NOTES DOWNLOAD BUTTON -->
             <button id="download-notes-btn" onclick="downloadNotesTextReport()" class="text-xs bg-gray-600 text-white font-semibold hover:bg-gray-700 px-3 py-1.5 rounded-lg shadow transition flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-7 8h14a2 2 0 002-2V5a2 2 0 00-2-2H9.586a1 1 0 01-.707-.293l-4.414 4.414a1 1 0 01-.293.707V19a2 2 0 002 2z" />
                </svg>
                Download Notes (TXT)
            </button>
        </div>
        
        <div id="report-feed" class="space-y-4">
            <div class="text-center text-gray-500 py-10">Loading inspection data...</div>
        </div>
    </div>

    <!-- TAB 3: RAW FILES (STORAGE BROWSER) -->
    <div id="tab-files" class="tab-content p-4 max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="font-bold text-gray-700">Raw Storage Browser</h2>
                <div class="flex gap-2">
                    <button onclick="browserUp()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs font-bold border">‚¨Ü Up</button>
                    <button onclick="refreshBrowser()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs font-bold border">‚Üª</button>
                </div>
            </div>
            <div id="browser-path" class="text-xs font-mono text-gray-500 mb-2 truncate">/</div>
            <div id="browser-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto">
                <!-- Raw files -->
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 flex justify-around items-center h-16 z-30 pb-safe">
        <button onclick="switchTab('inspect')" id="nav-inspect" class="nav-item active flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üì∑</span>
            <span class="text-[10px] font-bold mt-1">Inspect</span>
        </button>
        <button onclick="switchTab('report')" id="nav-report" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üìã</span>
            <span class="text-[10px] font-bold mt-1">Report</span>
        </button>
        <button onclick="switchTab('files')" id="nav-files" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-600 transition">
            <span class="text-xl">üóÑÔ∏è</span>
            <span class="text-[10px] font-bold mt-1">Raw Files</span>
        </button>
    </nav>

    <!-- PHOTO CAPTION MODAL -->
    <div id="caption-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex flex-col justify-center p-4">
        <div class="bg-white rounded-xl overflow-hidden shadow-2xl max-w-md mx-auto w-full">
            <div class="relative h-64 bg-gray-100 flex items-center justify-center">
                <img id="modal-img-preview" class="max-h-full max-w-full object-contain">
            </div>
            <div class="p-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Photo Caption</label>
                <textarea id="modal-caption-input" class="w-full border border-gray-300 rounded-lg p-3 text-sm h-24 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4 resize-none" placeholder="e.g. Hairline crack, vertical, approx 2mm width"></textarea>
                
                <button id="ai-caption-btn" onclick="generateAICaption()" class="w-full mb-3 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow transition flex items-center justify-center gap-2">
                    Analyze & Suggest Caption ‚ú®
                </button>
                
                <div class="flex gap-3">
                    <button onclick="cancelUpload()" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-lg transition">Discard</button>
                    <button onclick="confirmUpload()" id="modal-save-btn" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow transition">Save & Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOG EDITOR MODAL (New Universal Editor) -->
    <div id="editor-modal" class="fixed inset-0 z-50 bg-black/90 hidden flex flex-col justify-center p-4">
        <div class="bg-white rounded-xl overflow-hidden shadow-2xl max-w-md mx-auto w-full">
            <div class="bg-gray-100 p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-gray-800" id="editor-title">Edit Log Entry</h3>
                <button onclick="closeEditorModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div id="editor-photo-preview" class="hidden relative h-32 bg-gray-100 mb-3 flex items-center justify-center border border-gray-200 rounded">
                    <img id="editor-preview-img" class="max-h-full max-w-full object-contain">
                </div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="editor-label">Text</label>
                <textarea id="editor-text-input" class="w-full border border-gray-300 rounded-lg p-3 text-sm h-32 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none font-sans"></textarea>
                
                <button onclick="updateLogEntry()" id="editor-save-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Settings</h3>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-400 font-bold text-lg">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <!-- PROJECT SELECTOR -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Active Project</label>
                    <div class="flex gap-2">
                        <select id="project-select" class="flex-1 border border-gray-300 rounded p-2 text-sm bg-white" onchange="switchProject(this.value)">
                            <!-- Populated by JS -->
                        </select>
                        <button onclick="toggleNewProjectInput()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-lg font-bold shadow hover:bg-blue-200 transition" title="Add New Project">+</button>
                    </div>
                    
                    <!-- NEW PROJECT INPUT (Hidden) -->
                    <div id="new-project-div" class="hidden mt-2 p-2 bg-blue-50 rounded border border-blue-100">
                        <input type="text" id="new-project-input" placeholder="Enter Project ID (e.g. Pier-44)" class="w-full border border-blue-200 rounded p-2 text-sm mb-2">
                        <div class="flex gap-2">
                            <button onclick="createNewProject()" class="flex-1 bg-blue-600 text-white text-xs font-bold py-2 rounded">Create & Switch</button>
                            <button onclick="toggleNewProjectInput()" class="bg-gray-200 text-gray-600 px-3 rounded text-xs">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <h4 class="text-xs font-bold text-yellow-800 mb-1">Legacy Import</h4>
                    <p class="text-[10px] text-yellow-700 mb-2">Found files in storage but not in the report? Run this scanner.</p>
                    <button onclick="importLegacyFiles()" class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-xs font-bold py-2 rounded border border-yellow-300">
                        Scan & Import Missing Photos
                    </button>
                </div>

                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                    <h4 class="text-xs font-bold text-gray-800 mb-1">Debug Rules</h4>
                    <button onclick="copyFirestoreRules()" class="w-full bg-white hover:bg-gray-50 text-gray-600 text-xs font-bold py-2 rounded border border-gray-300 mb-2">
                        Copy Firestore Rules
                    </button>
                    <button onclick="copyStorageRules()" class="w-full bg-white hover:bg-gray-50 text-gray-600 text-xs font-bold py-2 rounded border border-gray-300">
                        Copy Storage Rules
                    </button>
                </div>
            </div>

            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="mt-6 w-full py-3 bg-gray-800 text-white font-bold rounded-lg">Close</button>
        </div>
    </div>

    <!-- Hidden Rules for Copying -->
    <div id="fs-rules" class="hidden">rules_version = '2'; service cloud.firestore { match /databases/{database}/documents { match /artifacts/{appId}/public/data/images/{document=**} { allow read, write: if request.auth != null; } } }</div>
    <div id="st-rules" class="hidden">rules_version = '2'; service firebase.storage { match /b/{bucket}/o { match /artifacts/{appId}/{allPaths=**} { allow read, write: if request.auth != null; } } }</div>

    <!-- PROCESSING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-black/80 hidden flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mb-4"></div>
        <p id="loading-text" class="font-medium">Uploading...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, where, onSnapshot, getDocs, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, listAll, getMetadata, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        import 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        
        function saveAs(blob, filename) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        // CONFIG
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        const config = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyD2jsJTjSlWf3SINS3u4fz3Lu5IYbI6N94", authDomain: "field-cam.firebaseapp.com", projectId: "field-cam", storageBucket: "field-cam.firebasestorage.app", messagingSenderId: "952385597528", appId: "1:952385597528:web:3a5b2011a4cc2b29e41a2d" };

        let db, storage, auth, user;
        let currentProject = localStorage.getItem('fc_active_project') || "Bridge-001";
        let knownProjects = new Set(JSON.parse(localStorage.getItem('fc_projects') || '["Bridge-001"]'));
        
        let pendingBlob = null;
        let pendingBase64 = null;
        let browserPath = `artifacts/${appId}/public/data/files`;
        let currentEditingItem = null;
        let currentReportFilter = 'photo'; 

        // INIT
        async function init() {
            const app = initializeApp(config);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);

            onAuthStateChanged(auth, (u) => {
                user = u;
                updateStatus(u ? 'online' : 'offline');
                if(u) {
                    loadReport();
                    browserPath = `artifacts/${appId}/public/data/files`;
                    loadBrowser(browserPath);
                }
            });

            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (token) { try { await signInWithCustomToken(auth, token); } catch { await signInAnonymously(auth); } }
            else { await signInAnonymously(auth); }

            document.getElementById('camera-input').onchange = handleCameraInput;
            document.getElementById('report-search').oninput = (e) => filterReport(e.target.value);
            
            updateProjectHeader();
            renderProjectOptions();
            // FIX: Use setTimeout to ensure DOM elements exist before setting filter
            setTimeout(() => {
                window.setReportFilter(currentReportFilter);
            }, 0);
        }

        // --- PROJECT MANAGEMENT ---
        window.toggleNewProjectInput = () => {
            const div = document.getElementById('new-project-div');
            div.classList.toggle('hidden');
            if(!div.classList.contains('hidden')) document.getElementById('new-project-input').focus();
        };

        window.createNewProject = () => {
            const input = document.getElementById('new-project-input');
            const val = input.value.trim();
            if(!val) return alert("Please enter a project ID");
            addProjectToSet(val);
            switchProject(val);
            input.value = "";
            toggleNewProjectInput();
        };

        window.switchProject = (pid) => {
            currentProject = pid;
            localStorage.setItem('fc_active_project', pid);
            updateProjectHeader();
            loadReport(); 
        };

        function addProjectToSet(pid) {
            if(!pid) return;
            knownProjects.add(pid);
            localStorage.setItem('fc_projects', JSON.stringify(Array.from(knownProjects)));
            renderProjectOptions();
        }

        function renderProjectOptions() {
            const select = document.getElementById('project-select');
            select.innerHTML = '';
            Array.from(knownProjects).sort().forEach(pid => {
                const opt = document.createElement('option');
                opt.value = pid;
                opt.text = pid;
                if(pid === currentProject) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function updateProjectHeader() {
            document.getElementById('project-header').innerText = `Project: ${currentProject}`;
        }

        // --- CAMERA FLOW ---
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function handleCameraInput(e) {
            const file = e.target.files[0];
            if (!file) return;
            pendingBlob = file;
            const url = URL.createObjectURL(file);
            document.getElementById('modal-img-preview').src = url;
            document.getElementById('modal-caption-input').value = "";
            document.getElementById('caption-modal').classList.remove('hidden');

            blobToBase64(file).then(base64Data => {
                pendingBase64 = base64Data;
            }).catch(e => {
                console.error("Failed to convert image for AI:", e);
                pendingBase64 = null;
            });
        }

        window.cancelUpload = () => {
            document.getElementById('caption-modal').classList.add('hidden');
            document.getElementById('camera-input').value = "";
            pendingBlob = null;
        }

        // --- GEMINI AI FUNCTION ---
        window.generateAICaption = async () => {
            if (!pendingBase64) return alert("Photo still loading or failed to convert.");
            const btn = document.getElementById('ai-caption-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div> Analyzing...';

            const systemPrompt = "You are a specialized structural inspection AI. Analyze the provided image of the structural component. Identify key features or potential defects (like rust, cracking, spalling, or moisture) and generate a single, concise, professional inspection note/caption (maximum 15 words). Do not describe the photo itself; focus on the observation.";
            
            const userQuery = `Analyze this image of a structural component.`;
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: pendingBlob.type || "image/jpeg",
                                data: pendingBase64
                            }
                        }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "AI analysis failed.";
                
                document.getElementById('modal-caption-input').value = text.trim();
                
            } catch (e) {
                console.error("Gemini API Error:", e);
                alert("AI Analysis failed due to a network or API error.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        window.confirmUpload = async () => {
            if (!user || !pendingBlob) return alert("Error: No user or file.");
            const caption = document.getElementById('modal-caption-input').value.trim() || "No Caption";
            const btn = document.getElementById('modal-save-btn');
            
            btn.disabled = true;
            btn.innerText = "Uploading...";
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const id = Date.now().toString();
                const path = `artifacts/${appId}/public/data/files/${currentProject}/${id}.jpg`;
                const storageRef = ref(storage, path);
                const snap = await uploadBytes(storageRef, pendingBlob);
                const url = await getDownloadURL(snap.ref);

                const docRef = doc(db, `artifacts/${appId}/public/data/images`, id);
                await setDoc(docRef, {
                    id: id,
                    type: 'photo',
                    projectId: currentProject,
                    url: url,
                    storagePath: path,
                    caption: caption,
                    timestamp: Date.now(),
                    dateString: new Date().toLocaleString()
                });

                addProjectToSet(currentProject);
                document.getElementById('caption-modal').classList.add('hidden');
                document.getElementById('camera-input').value = "";
                switchTab('report');

            } catch (e) {
                console.error(e);
                if (e.code === 'storage/unauthorized') {
                    alert("Permission Denied! Check Storage Rules.");
                } else {
                    alert("Upload Failed: " + e.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerText = "Save & Upload";
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // --- NOTE FLOW ---
        window.confirmQuickNote = async () => {
            const textInput = document.getElementById('quick-note-input');
            const text = textInput.value.trim();
            if (!text) return;
            if (!user) return alert("Error: No user found.");

            const btn = document.getElementById('quick-note-save-btn');
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const id = Date.now().toString();
                const docRef = doc(db, `artifacts/${appId}/public/data/images`, id);
                
                await setDoc(docRef, {
                    id: id,
                    type: 'note',
                    projectId: currentProject,
                    text: text,
                    timestamp: Date.now(),
                    dateString: new Date().toLocaleString()
                });

                addProjectToSet(currentProject);
                textInput.value = ""; // Clear the input
                switchTab('report');

            } catch(e) {
                console.error(e);
                alert("Note Save Failed: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Save Note";
            }
        };

        // --- EDITING FLOW ---
        window.openEditorModal = (id, type) => {
            const item = cachedItems.find(i => i.id === id);
            if (!item) return;
            currentEditingItem = item;
            
            const editorModal = document.getElementById('editor-modal');
            const title = document.getElementById('editor-title');
            const label = document.getElementById('editor-label');
            const textArea = document.getElementById('editor-text-input');
            const imgPreviewDiv = document.getElementById('editor-photo-preview');
            const imgPreview = document.getElementById('editor-preview-img');

            if (type === 'photo') {
                title.innerText = `Edit Photo Caption (ID: ${item.id.substring(8)})`;
                label.innerText = "Photo Caption";
                textArea.value = item.caption || "";
                imgPreview.src = item.url;
                imgPreviewDiv.classList.remove('hidden');
            } else { // type === 'note'
                title.innerText = `Edit Field Note (ID: ${item.id.substring(8)})`;
                label.innerText = "Note Text";
                textArea.value = item.text || "";
                imgPreviewDiv.classList.add('hidden');
            }

            editorModal.classList.remove('hidden');
        };

        window.closeEditorModal = () => {
            document.getElementById('editor-modal').classList.add('hidden');
            currentEditingItem = null;
        };

        window.updateLogEntry = async () => {
            if (!currentEditingItem) return;
            const updatedText = document.getElementById('editor-text-input').value.trim();
            const btn = document.getElementById('editor-save-btn');
            
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/images`, currentEditingItem.id);
                let updateData = {};

                if (currentEditingItem.type === 'photo') {
                    updateData = { caption: updatedText };
                } else {
                    updateData = { text: updatedText };
                }

                await setDoc(docRef, updateData, { merge: true });

                closeEditorModal();

            } catch (e) {
                console.error("Update Failed:", e);
                alert("Update Failed: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Save Changes";
            }
        };


        // --- REPORT LOG ---
        let reportUnsub;
        let cachedItems = []; 
        function loadReport() {
            if (reportUnsub) reportUnsub();
            const q = query(
                collection(db, `artifacts/${appId}/public/data/images`), 
                where("projectId", "==", currentProject)
            );

            reportUnsub = onSnapshot(q, (snap) => {
                const items = [];
                snap.forEach(d => items.push(d.data()));
                items.sort((a,b) => b.timestamp - a.timestamp);
                cachedItems = items; 
                renderReport(items);
            });
        }
        
        window.setReportFilter = (filter) => {
            currentReportFilter = filter;
            // Update button styles
            document.querySelectorAll('.report-nav-item').forEach(btn => {
                if (btn) btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`nav-log-${filter}`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Set Download Button Visibility
            const btnPhotos = document.getElementById('download-photos-btn');
            const btnNotes = document.getElementById('download-notes-btn');
            
            if (btnPhotos) btnPhotos.classList.toggle('hidden', filter === 'note');
            if (btnNotes) btnNotes.classList.toggle('hidden', filter === 'photo');

            renderReport(cachedItems);
        }

        function renderReport(items) {
            const feed = document.getElementById('report-feed');
            feed.innerHTML = "";
            
            const filteredItems = items.filter(item => {
                if (currentReportFilter === 'photo') return item.type === 'photo';
                if (currentReportFilter === 'note') return item.type === 'note';
                return true; // 'all'
            });
            
            if (filteredItems.length === 0) {
                feed.innerHTML = `<div class="text-center text-gray-400 py-10">No ${currentReportFilter !== 'all' ? currentReportFilter + ' ' : ''} observations for ${currentProject} yet.</div>`;
                return;
            }

            filteredItems.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white rounded-lg shadow border border-gray-200 overflow-hidden flex";
                
                let visualSide, contentSide;

                if (item.type === 'note') {
                    visualSide = `<div class="w-16 bg-yellow-50 flex-shrink-0 flex items-center justify-center border-r border-yellow-100 text-yellow-600"><span class="text-2xl">üìù</span></div>`;
                    contentSide = `<p class="text-sm text-gray-800 font-medium leading-snug whitespace-pre-wrap">${item.text}</p>`;
                } else {
                    visualSide = `
                        <div class="w-1/3 bg-gray-100 flex-shrink-0 relative cursor-pointer group" onclick="window.open('${item.url}', '_blank')">
                            <img src="${item.url}" class="absolute inset-0 w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition"></div>
                        </div>
                    `;
                    contentSide = `<p class="text-sm text-gray-800 font-medium leading-snug">${item.caption}</p>`;
                }

                div.innerHTML = `
                    ${visualSide}
                    <div class="p-3 flex-1 flex flex-col justify-between">
                        <div>
                            <div class="text-xs text-gray-400 font-mono mb-1 flex justify-between">
                                <span>${item.dateString || "Unknown Date"}</span>
                                ${item.type === 'note' ? '<span class="text-xs text-yellow-600 font-bold bg-yellow-100 px-1 rounded">NOTE</span>' : ''}
                            </div>
                            ${contentSide}
                        </div>
                        <div class="flex justify-end mt-2 gap-2">
                            <button onclick="openEditorModal('${item.id}', '${item.type}')" class="text-xs text-blue-500 hover:text-blue-700 font-bold px-2 py-1 rounded hover:bg-blue-50">
                                Edit
                            </button>
                            <button onclick="deleteEntry('${item.id}', '${item.storagePath || ''}')" class="text-xs text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded hover:bg-red-50">Delete</button>
                        </div>
                    </div>
                `;
                feed.appendChild(div);
            });
        }

        window.deleteEntry = async (id, path) => {
            if(!confirm("Delete this entry permanently?")) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/images`, id));
                if(path) await deleteObject(ref(storage, path)).catch(e => console.warn("File delete fail", e));
            } catch(e) { alert("Delete error: "+e.message); }
        }

        function filterReport(txt) {
            const lower = txt.toLowerCase();
            const cards = document.querySelectorAll('#report-feed > div');
            cards.forEach(c => {
                const text = c.innerText.toLowerCase();
                c.style.display = text.includes(lower) ? 'flex' : 'none';
            });
        }
        
        // --- PDF GENERATION LOGIC ---
        window.generateReportPDF = async () => {
            if (cachedItems.length === 0) return alert("Report is empty. Add photos or notes first.");
            
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                return alert("Error: PDF library (jspdf) failed to load. Please refresh the app.");
            }
            
            setLoading(true, "Generating Report...");
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: 'letter' });
                let y = 15;
                const margin = 15;
                const pW = 215.9;

                // Title Page Header
                doc.setFontSize(20);
                doc.text(`Structural Inspection Report`, pW / 2, y, { align: 'center' }); y += 10;
                doc.setFontSize(14);
                doc.text(`Project ID: ${currentProject}`, pW / 2, y, { align: 'center' }); y += 10;
                doc.setFontSize(10);
                doc.text(`Date Generated: ${new Date().toLocaleString()}`, pW / 2, y, { align: 'center' }); y += 15;
                
                // Separate photos and notes
                const photos = cachedItems.filter(i => i.type === 'photo');
                const notes = cachedItems.filter(i => i.type === 'note');

                // --- PHOTO LOG SECTION ---
                doc.addPage(); y = margin;
                doc.setFontSize(16);
                doc.text("Photo Log", margin, y); y += 10;

                const photoW = 80;
                const photoH = 60;
                const gap = 5;
                let currentX = margin;

                for (const p of photos) {
                    if (y + photoH + 20 > doc.internal.pageSize.height - margin) {
                        doc.addPage();
                        y = margin;
                    }

                    try {
                        const response = await fetch(p.url);
                        const blob = await response.blob();
                        const base64 = await new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result); rd.readAsDataURL(blob); });
                        doc.addImage(base64, 'JPEG', currentX, y, photoW, photoH);
                    } catch (e) {
                        console.error("Image fetch failed:", e);
                        doc.text("Image Unavailable", currentX + 5, y + 30);
                    }

                    doc.setFontSize(9);
                    doc.setFont("helvetica", "bold");
                    doc.text(`ID: ${p.id.substring(8)}`, currentX + photoW + gap, y + 4);
                    
                    doc.setFont("helvetica", "normal");
                    doc.text(p.dateString, currentX + photoW + gap, y + 8);
                    
                    doc.setFontSize(10);
                    const captionLines = doc.splitTextToSize(p.caption, pW - (currentX + photoW + gap) - margin);
                    doc.text(captionLines, currentX + photoW + gap, y + 14);

                    y += photoH + 10; 
                }

                // --- NOTES SECTION ---
                if (notes.length > 0) {
                    doc.addPage(); y = margin;
                    doc.setFontSize(16);
                    doc.text("Observation Notes", margin, y); y += 10;
                    
                    for (const n of notes) {
                        if (y > doc.internal.pageSize.height - margin * 2) {
                            doc.addPage();
                            y = margin;
                        }
                        
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "bold");
                        doc.text(`[Note] ${n.dateString}`, margin, y); y += 4;
                        
                        doc.setFont("helvetica", "normal");
                        const textLines = doc.splitTextToSize(n.text, pW - margin * 2);
                        doc.text(textLines, margin, y);
                        y += (textLines.length * 4) + 6; 
                    }
                }

                doc.save(`Structural_Report_${currentProject}_${Date.now()}.pdf`);
            } catch (error) {
                console.error("PDF Generation failed:", error);
                alert("Report generation failed. See console for details.");
            } finally {
                setLoading(false);
            }
        };

        // --- FILES BROWSER ---
        async function loadBrowser(path) {
            browserPath = path;
            const grid = document.getElementById('browser-grid');
            document.getElementById('browser-path').innerText = path;
            grid.innerHTML = '<div class="col-span-full text-center text-gray-400 text-sm">Scanning...</div>';

            try {
                const res = await listAll(ref(storage, path));
                grid.innerHTML = "";

                res.prefixes.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "bg-yellow-50 border border-yellow-200 rounded p-3 text-center cursor-pointer hover:bg-yellow-100";
                    div.onclick = () => loadBrowser(p.fullPath);
                    div.innerHTML = `<div class="text-2xl mb-1">üìÅ</div><div class="text-xs truncate font-bold text-yellow-800">${p.name}</div>`;
                    grid.appendChild(div);
                });

                for (const item of res.items) {
                    const url = await getDownloadURL(item);
                    const div = document.createElement('div');
                    div.className = "bg-white border border-gray-200 rounded overflow-hidden shadow-sm relative group";
                    div.innerHTML = `
                        <div class="h-24 bg-gray-100 relative">
                            <img src="${url}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-2 text-[10px] text-gray-500 truncate">${item.name}</div>
                        <a href="${url}" target="_blank" class="absolute inset-0"></a>
                    `;
                    grid.appendChild(div);
                }
                
                if(res.prefixes.length === 0 && res.items.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-300 text-sm py-4">Empty Folder</div>';
                }

            } catch(e) {
                console.warn("Browser Error", e.code);
                if(e.code === 'storage/unauthorized') {
                    grid.innerHTML = `
                        <div class="col-span-full text-center text-red-500 text-xs py-4 p-4 border border-red-200 rounded bg-red-50">
                            <p class="font-bold">Setup Required</p>
                            <p class="mt-1">Permission denied. Check Rules in Settings.</p>
                        </div>`;
                } else if (e.code === 'storage/object-not-found') {
                     grid.innerHTML = `<div class="col-span-full text-center text-gray-400 text-xs py-4">Folder not found. Upload a photo first.</div>`;
                } else {
                    grid.innerHTML = `<div class="col-span-full text-center text-red-400 text-xs py-4">Error: ${e.code}</div>`;
                }
            }
        }

        window.browserUp = () => {
            const parts = browserPath.split('/');
            if(parts.length > 1) { 
                parts.pop(); 
                loadBrowser(parts.join('/')); 
            }
        };
        window.refreshBrowser = () => loadBrowser(browserPath);

        // --- LEGACY IMPORT ---
        window.importLegacyFiles = async () => {
            if(!confirm("Scan storage for files not in the Logbook? This may take a moment.")) return;
            const btn = document.querySelector('button[onclick="importLegacyFiles()"]');
            btn.innerText = "Scanning..."; btn.disabled = true;
            
            try {
                let count = 0;
                const scan = async (refDir, projName) => {
                    const res = await listAll(refDir);
                    for(const f of res.items) {
                        const id = f.name.split('.')[0];
                        const url = await getDownloadURL(f);
                        await setDoc(doc(db, `artifacts/${appId}/public/data/images`, id), {
                            id: id, projectId: projName || "Unsorted", url: url, storagePath: f.fullPath,
                            caption: "Imported from Storage", timestamp: Date.now(), dateString: "Imported"
                        }, { merge: true });
                        count++;
                    }
                    for(const p of res.prefixes) {
                        addProjectToSet(p.name);
                        await scan(p, p.name);
                    }
                };
                
                await scan(ref(storage, `artifacts/${appId}/public/data/files`), "Unsorted");
                alert(`Imported ${count} files.`);
            } catch(e) { alert("Scan error: " + e.message); }
            finally { btn.innerText = "Scan & Import Missing Photos"; btn.disabled = false; }
        }

        // --- UTILS ---
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-blue-600'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.getElementById(`nav-${id}`).classList.add('active', 'text-blue-600');
            if(id === 'files') loadBrowser(browserPath);
        }

        window.updateProjectID = (val) => {
            currentProject = val;
            document.getElementById('project-header').innerText = `Project: ${val}`;
            loadReport();
        }

        window.refreshReport = () => loadReport();
        window.generateReportPDF = () => generateReportPDF();

        window.downloadAllPhotosZip = async () => {
            const photoItems = cachedItems.filter(item => item.type === 'photo');
            if (photoItems.length === 0) return alert("No photos to download for this project.");
            
            setLoading(true, "Preparing ZIP download...");
            
            try {
                const zip = new JSZip();
                
                const downloadPromises = photoItems.map(async (p) => {
                    if (p.storagePath) {
                        const response = await fetch(p.url);
                        const blob = await response.blob();
                        const filename = `${currentProject}_${p.id.substring(8)}_${p.caption.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20)}.jpg`;
                        zip.file(filename, blob);
                    }
                });

                await Promise.all(downloadPromises);

                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${currentProject}_Photos.zip`);
            } catch (e) {
                console.error("ZIP Download failed:", e);
                alert("Download failed. Check console for details.");
            } finally {
                setLoading(false);
            }
        };

        // --- NEW: DOWNLOAD NOTES TXT REPORT ---
        window.downloadNotesTextReport = () => {
            const noteItems = cachedItems.filter(item => item.type === 'note');
            if (noteItems.length === 0) return alert("No notes available to download for this project.");

            let textContent = `STRUCTURAL INSPECTION NOTES REPORT\nProject ID: ${currentProject}\nGenerated: ${new Date().toLocaleString()}\n\n========================================\n\n`;

            noteItems.forEach((n, index) => {
                textContent += `--- NOTE #${index + 1} (ID: ${n.id.substring(8)}) ---\n`;
                textContent += `Date: ${n.dateString}\n`;
                textContent += `Project: ${n.projectId}\n\n`;
                textContent += `${n.text}\n\n`;
                textContent += `----------------------------------------\n\n`;
            });

            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, `${currentProject}_Notes_Report.txt`);
        };

        window.copyFirestoreRules = () => {
            navigator.clipboard.writeText(document.getElementById('fs-rules').innerText).then(()=>alert("Firestore Rules Copied! Paste into Firestore Console."));
        }
        window.copyStorageRules = () => {
            navigator.clipboard.writeText(document.getElementById('st-rules').innerText).then(()=>alert("Storage Rules Copied! Paste into Storage Console."));
        }

        function updateStatus(s) {
            const ind = document.getElementById('status-indicator');
            ind.className = `w-2 h-2 rounded-full ${s === 'online' ? 'bg-green-500' : 'bg-red-500'}`;
        }

        init();
    </script>
</body>
</html>
